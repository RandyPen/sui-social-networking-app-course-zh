# 调用合约

调用合约时，最常用的功能是 sui client, 可以先简单[浏览源代码](https://github.com/MystenLabs/sui/blob/main/sdk/typescript/src/client/client.ts)。这一小节会过一遍常用的功能。

我们先把上一节课的[示例代码](../../unit-1/example_projects/profile_clock/sources/profile_clock.move)发布到测试网上，为了方便学习，这里也直接[发布了一个版本](https://explorer.polymedia.app/object/0xf88ed6fdffa373a09a1a54fbad1ac4730219142f7fa798bdcf632d5f159e4a18?network=testnet)，方便大家调用。testnet package ID 是 `0xf88ed6fdffa373a09a1a54fbad1ac4730219142f7fa798bdcf632d5f159e4a18`.

## 签名并执行交易 signAndExecuteTransaction

先跳转到[example_project文件夹](../example_projects/)，然后执行`execute.ts`程序。
```bash
bun run execute.ts
```
可以看到执行结果返回一串哈希码，[把该哈希码复制到区块链浏览器](https://explorer.polymedia.app/txblock/EajmE9pSVJvhD6XL4atJrjCgYTEfzMQSj91ArzD2Ea4Y?network=testnet)可以看到执行记录。

在这个最简单的`execute.ts`示例程序中。

```ts
const client = new SuiClient({
    url: getFullnodeUrl("testnet"),
});
```

是在程序内初始化一个Sui客户端，并且指定网络是在testnet.

```ts
const tx = new Transaction();
tx.moveCall({
    package: PACKAGE,
    module: "profile_clock",
    function: "mint",
    arguments: [
        tx.pure(bcs.string().serialize("Example").toBytes()),
    ],
});
```
初始化一个交易，并且声明交易内容，是调用`PACKAGE`的`profile_clock`模块的`mint`函数。
对比原始合约代码，输入参数有两个 `handle: String, ctx: &mut TxContext`, 其中`ctx`可以免输入。
`String`变量的输入需要用`bcs`编码方式编码，记住常见的输入格式即可。

```ts
const result = await client.signAndExecuteTransaction({ signer: keypair, transaction: tx });
console.log(result);
```
这一步骤就是关键，会使用私钥签署交易并执行。最后打印输出执行结果。

## 查询地址持有的Object getOwnedObjects

在调用[合约](../../unit-1/example_projects/profile_clock/sources/profile_clock.move)的`click`函数时，需要输入用户持有的`Profile` Object 的地址和时间`Clock`作为参数。

`getOwnedObjects`可以查询某个地址持有的所有Object.
```ts
const object_list = await client.getOwnedObjects({owner: address});
```
查询输入的参数应该如何填写，可以查看源代码。

这里只需要查找目前地址下的`Profile` Object 的信息，可以额外输入筛选信息。并且返回所有检索到符合条件的第一个Object的ID, 保存为`profile_id`.

```ts
const struct_type = "0xf88ed6fdffa373a09a1a54fbad1ac4730219142f7fa798bdcf632d5f159e4a18::profile_clock::Profile";
const object_list = await client.getOwnedObjects({ owner: address, filter: { StructType: struct_type } });
const profile_id = object_list.data[0].data!.objectId;
```
这里的`StructType`是由`package_id::module::struct`格式组成的字符串。

有了这些信息之后，就可以调用`click`函数。
```ts
const PACKAGE: string = '0xf88ed6fdffa373a09a1a54fbad1ac4730219142f7fa798bdcf632d5f159e4a18';
const tx = new Transaction();
tx.moveCall({
    package: PACKAGE,
    module: "profile_clock",
    function: "click",
    arguments: [
        tx.object(profile_id),
        tx.object("0x6"),
    ],
});
```